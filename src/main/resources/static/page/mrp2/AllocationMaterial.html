<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>缺料分配</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=317"/>
    <!--[if lt IE 9]>
    <script src="../../assets/libs/html5shiv/html5shiv.min.js"></script>
    <script src="../../assets/libs/respond/respond.min.js"></script>
    <![endif]-->
    <style>
        div[lay-id="tableArrivalPlan"] .layui-table .layui-table-cell {
            height: auto;
            padding: 0px 0px;
        }
        div[lay-id="tableArrivalPlan"] .layui-table .layui-table-cell .layui-input{
            height: 20px;
            font-size: 12px;
            border: none;
        }
    </style>
</head>
<body>
<!-- 加载动画 -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>
<!-- 正文开始 -->
<div class="layui-card">
    <div class="layui-card-body">
        <!-- 表格 -->
        <table id="tableArrivalPlan" lay-filter="tableArrivalPlan"></table>
        <!-- 按钮 -->
        <div class="text-center" style="padding-top: 15px;padding-bottom: 15px;">
            <button type="button" class="layui-btn layui-btn-sm" id="saveBtn" lay-submit>保存</button>
            <button type="button" class="layui-btn layui-btn-sm" id="closeBtn" ew-event="closeDialog">关闭</button>
        </div>
    </div>
</div>
<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=317"></script>
<script>
    layui.use(['layer', 'steps', 'form', 'table', "notice", "dropdown", 'admin', 'laydate'], function () {
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;
        var notice = layui.notice;
        var admin = layui.admin;
        var laydate = layui.laydate;

        var mrpVer = admin.getLayerData().mrpVer;
        var plant = admin.getLayerData().plant;
        var material = admin.getLayerData().material;
        var fabDate = admin.getLayerData().fabDate;

        $.get('/mrp/allocation/getMaterialAllocation', {
            plant: plant,
            material: material,
            fabDate: fabDate
        }, function(res) {
            table.render({
                elem: '#tableArrivalPlan',
                data: res.data,
                cols: [[
                    {type: 'numbers', align: 'center'},
                    {field: 'supplier', title: '供应商ID', align: 'center'},
                    {field: 'supplierName', title: '供应商', align: 'center'},
                    {field: 'fabDate', title: '要望日期', align: 'center', width:120, templet: function(d) {
                        return '<input type="text" class="layui-input" id="allocationDate_' + d.supplier +'" value="'+d.allocationDate+'">'
                        }},
                    {field: 'allocationQty', title: '分配', align: 'center', edit: 'text'}
                ]],
                page: {layout: ['count']},
                size: 'sm',
                done: function(res){
                    var data = res.data;
                    console.log(data);
                    for(var i=0; i<data.length; i++) {
                        var elem = '#allocationDate_'+data[i].supplier;
                        laydate.render({
                            elem: elem //指定元素
                        });
                    }
                }
            });
        });

        //保存提交
        $("#saveBtn").click(function() {
            var data = layui.table.cache['tableArrivalPlan'];
            for(var i=0; i<data.length; i++) {
                data[i].allocationDate = $("#allocationDate_"+data[i].supplier).val();
            }
            $.post('/mrp/allocation/saveAllocations', {
                mrpVer: mrpVer,
                plant: plant,
                material: material,
                fabDate: fabDate,
                jsons: JSON.stringify(data)
            }, function(res) {
                if(res.code === 200) {
                    admin.putLayerData('editOk', true);
                    admin.putLayerData('allocationTotal', res.data);
                    admin.closeThisDialog();
                } else {
                    notice.msg(res.msg, {icon: 2});
                }
            });
        });
    });
</script>
</body>
</html>