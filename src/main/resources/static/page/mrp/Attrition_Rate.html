<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>损耗率</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=317"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 页面加载loading -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <!-- 表格工具栏 -->
            <form class="layui-form toolbar">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">供应商:</label>
                        <div class="layui-input-inline">
                            <input class="layui-input" name="vender">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">供应商Code:</label>
                        <div class="layui-input-inline">
                            <input class="layui-input" name="venderCode">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">物料组:</label>
                        <div class="layui-input-inline">
                            <input class="layui-input" name="materialGroup">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">料号:</label>
                        <div class="layui-input-inline">
                            <input class="layui-input" name="material">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">状态:</label>
                        <div class="layui-input-inline">
                            <input type="checkbox" name="isEffect" title="生效" value="true" lay-skin="primary" checked>
                        </div>
                    </div>

                    <div class="layui-inline">&emsp;
                        <button class="layui-btn icon-btn" lay-filter="search" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>
                    </div>
                </div>
            </form>

            <!-- 表格 -->
            <table id="attritionRateTable" lay-filter="attritionRateTable"></table>
        </div>
    </div>
</div>

<!-- 表格工具栏 -->
<script type="text/html" id="toolbar">
    <p>
        <button id="file-btn-upload" class="layui-btn layui-btn-sm layui-btn-normal icon-btn">
            <i class="layui-icon">&#xe681;</i>&nbsp;导入
        </button>&nbsp;
        <button id="file-btn-download" class="layui-btn layui-btn-sm layui-btn-danger icon-btn">
            <i class="layui-icon layui-icon-download-circle"></i>&nbsp;导出
        </button>

        <button class="layui-btn layui-btn-sm layui-btn-danger icon-btn" lay-event="add">
            <i class="layui-icon layui-icon-download-circle"></i>&nbsp;添加
        </button>
    </p>
</script>

<!-- 表格操作列 -->
<script type="text/html" id="attritionRateTbBar">
    <button lay-event="add" type="button" class="layui-btn layui-btn-normal layui-btn-xs"><i class="layui-icon"></i></button>
    <button lay-event="del" type="button" class="layui-btn layui-btn-normal layui-btn-xs"><i class="layui-icon"></i></button>
</script>

<!-- 表单弹窗 -->
<script type="text/html" id="attritionRateEditDialog">
    <form id="attritionRateEditForm" lay-filter="attritionRateEditForm" class="layui-form model-form"
          style="padding-right: 20px;">
        <div class="layui-row">
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label">供应商Code</label>
                    <div class="layui-input-block">
                        <input name="venderCode" placeholder="请输入供应商Code" class="layui-input" lay-verify="required"/>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">Model</label>
                    <div class="layui-input-block">
                        <input name="venderModel" placeholder="请输入Model" class="layui-input" lay-verify="required"/>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">物料组</label>
                    <div class="layui-input-block">
                        <input name="materialGroup" placeholder="请输入物料组" class="layui-input" lay-verify="required"/>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">损耗率</label>
                    <div class="layui-input-block">
                        <input name="attritionRate" placeholder="请输入损耗率" class="layui-input" type="number" lay-verify="required"/>
                    </div>
                </div>
            </div>
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label">供应商</label>
                    <div class="layui-input-block">
                        <input name="vender" placeholder="请输入供应商" class="layui-input" lay-verify="required"/>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">厂商料号</label>
                    <div class="layui-input-block">
                        <input name="venderMaterial" placeholder="请输入厂商料号" class="layui-input" lay-verify="required"/>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">料号</label>
                    <div class="layui-input-block">
                        <input name="material" placeholder="请输入料号" class="layui-input" lay-verify="required"/>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">生效日期</label>
                    <div class="layui-input-block">
                        <input id="effectDate" name="effectDate" placeholder="请输入生效日期" class="layui-input" lay-verify="required"/>
                    </div>
                </div>
            </div>
            <div class="layui-col-12">
                <div class="layui-form-item">
                    <label class="layui-form-label">说明</label>
                    <div class="layui-input-block">
                        <textarea name="memo" placeholder="请输入说明" class="layui-textarea"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn" lay-filter="attritionRateEditSubmit" lay-submit>保存</button>
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
        </div>
    </form>
</script>
<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=317"></script>
<script>
    layui.use(['layer', 'form', 'table', 'admin', 'laydate', 'notice', 'upload'], function () {
        var $ = layui.jquery;
        var form = layui.form;
        var table = layui.table;
        var notice = layui.notice;
        var upload = layui.upload;
        var admin = layui.admin;
        var laydate = layui.laydate;

        /* 表格渲染 */
        table.render({
            elem: '#attritionRateTable',
            url: '/mrp/attritionRate',
            method: 'post',
            page: true,
            cols: [[
                {field: 'venderCode', title: '供应商Code', align: 'center'},
                {field: 'vender', title: '供应商', align: 'center'},
                {field: 'venderModel', title: '厂商Model', align: 'center'},
                {field: 'venderMaterial', title: '厂商料号', align: 'center'},
                {field: 'materialGroup', title: '物料组', align: 'center'},
                {field: 'material', title: '料号', align: 'center'},
                {field: 'attritionRate', title: '损耗率', align: 'center'},
                {field: 'effectDate', title: '生效日期', align: 'center'},
                {title: '失效日期', align: 'center',
                    templet: function(d) {
                        if(d.expireDate === '9999-01-31') {
                            return '';
                        } else {
                            return d.expireDate;
                        }
                    }
                },
                {field: 'memo', title: '说明', align: 'center'},
                {title: '操作', toolbar: '#attritionRateTbBar', align: 'center'}
            ]],
            size: 'sm',
            even: true,
            toolbar: "#toolbar",
            done: function() {
                // 行颜色渲染

                // 上传
                upload.render({
                    elem: '#file-btn-upload',
                    accept: 'file',
                    url: '/mrp/attritionRate/importAttritionRate',
                    done: function (res) {
                        console.log(res);
                        if (res.code === 200) {
                            notice.msg('上传成功', {icon: 5});
                        } else {
                            notice.msg(res.msg, {icon: 2});
                        }
                    }
                });
            }
        });

        /* 表格头工具栏点击事件 */
        table.on('toolbar(attritionRateTable)', function (obj) {
            if (obj.event === 'add') { // 添加
                showEditModel();
            }
        });

        /* 表格工具条点击事件 */
        table.on('tool(attritionRateTable)', function (obj) {
            if (obj.event === 'add') { // 添加
                showEditModel(obj.data);
            } else if (obj.event === 'del') { // 删除
                var loadIndex = layer.load(2);
                $.post('/mrp/attritionRate/del', {id: obj.data.id}, function (res) {
                    layer.close(loadIndex);
                    if (res.code === 200) {
                        layer.msg(res.msg, {icon: 1});
                        $("button[lay-filter=search]").click();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                }, 'json');
            }
        });

        /* 表格搜索 */
        form.on('submit(search)', function (data) {
            if(!data.field.isEffect) {
                data.field.isEffect = false;
            }
            table.reload('attritionRateTable', {where: data.field});
            return false;
        });

        // 弹框
        var showEditModel = function(mData) {
            admin.open({
                type: 1,
                area: '600px',
                title: (mData ? '修改' : '添加') + '损耗率',
                content: $('#attritionRateEditDialog').html(),
                success: function (layero, dIndex) {
                    // 回显表单数据
                    form.val('attritionRateEditForm', mData);
                    //年月选择器
                    laydate.render({
                        elem: '#effectDate'
                    });
                    // 表单提交事件
                    form.on('submit(attritionRateEditSubmit)', function (data) {
                        var loadIndex = layer.load(2);
                        $.post('/mrp/attritionRate/save', data.field, function (res) {
                            layer.close(loadIndex);
                            if (res.code === 200) {
                                layer.close(dIndex);
                                layer.msg(res.msg, {icon: 1});
                                $("button[lay-filter=search]").click();
                            } else {
                                layer.msg(res.msg, {icon: 2});
                            }
                        }, 'json');
                        return false;
                    });
                    // 弹窗不出现滚动条
                    $(layero).children('.layui-layer-content').css('overflow', 'visible');
                }
            });
        };
    });
</script>
</body>
</html>
