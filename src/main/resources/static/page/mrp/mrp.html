<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>MRP</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=317"/>
    <!--[if lt IE 9]>
    <script src="../../assets/libs/html5shiv/html5shiv.min.js"></script>
    <script src="../../assets/libs/respond/respond.min.js"></script>
    <![endif]-->

    <style>
        .layui-table-view .layui-table[lay-size="sm"] .layui-table-cell {
            height: auto;
        }
        .layui-table-cell {
            height: auto;
            padding: 0 0;
        }
        .div_border {
            border-width: 1px;
            border-style: solid;
            border-color:#e6e6e6;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        .plan {
            margin: -5px 0px;
            text-align: center;
        }
        .plan .plan_child {
            height: 25px;
            line-height: 25px;
        }
    </style>
</head>
<body>
<!-- 页面加载loading -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">
            <i class="layui-icon layui-icon-tabs"></i>
            <span>MRP</span>
        </div>
        <div class="layui-card-body">
            <!-- 表格工具栏 -->
            <form class="layui-form toolbar">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">MRP版本:</label>
                        <div class="layui-input-inline">
                            <select name="mrpVer" id="mrpVer" lay-search=""></select>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">Material:</label>
                        <div class="layui-input-inline">
                            <input class="layui-input" name="material" placeholder="请输入搜索材料" value="212000T-00C">
                        </div>
                    </div>

                    <div class="layui-inline">
                        <button class="layui-btn icon-btn" lay-filter="search" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>
                    </div>
                </div>
            </form>

            <!-- 表格 -->
            <div class="layui-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this">MRP运算结果</li>
                    <li>需求量及损耗量</li>
                    <li>到货计划</li>
                    <li>结余量</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <table id="tableMrp" lay-filter="tableMrp"></table>
                    </div>
                    <div class="layui-tab-item">
                        <table id="tableDemandAndLoss" lay-filter="tableDemandAndLoss"></table>

                        <table id="tableDemandTemp" lay-filter="tableDemandTemp"></table>
                    </div>
                    <div class="layui-tab-item">
                        <table id="tableArrivalPlan" lay-filter="tableArrivalPlan"></table>
                    </div>
                    <div class="layui-tab-item">
                        <table id="tableBalance" lay-filter="tableBalance"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="DemoPlan">
    <div class="plan">
        <div class="plan_child div_border">需求量</div>
        <div class="plan_child div_border">损耗量</div>
        <div class="plan_child div_border">到货量</div>
        <div class="plan_child div_border">结余量</div>
    </div>
</script>

<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=317"></script>
<script>
    layui.use(['form', 'notice', 'table', 'element'], function() {
        var form = layui.form;
        var notice = layui.notice;
        var $ = layui.$;
        var table = layui.table;
        var element = layui.element;

        // 获取MRP版本下拉框选项
        $.ajax({
            type: 'get',
            url: '/mrp/getMrpVer',
            success: function(data){
                if(data.code === 200) {
                    for(var i=0; i<data.data.length; i++) {
                        $('#mrpVer').append(new Option(data.data[i], data.data[i]));
                    }
                    form.render('select');
                } else {
                    notice.msg(data.msg, {icon: 2});
                }
            },
            error: function(res) {
                notice.msg("获取MRP版本下拉框选项请求失败，" + res.status, {icon: 2});
            }
        });

        // 表格渲染
        table.render({
            elem: '#tableMrp',
            data: [],
            cols: [],
            size: 'sm',
            page: true,
            limit: 50,
            limits: [20, 50, 70, 100, 200, 300],
            even: true
        });

        table.render({
            elem: '#tableDemandAndLoss',
            data: [],
            cols: [[
                {type: 'numbers', align: 'center', width: 60},
                {field: 'fabDate', title: '日期', align: 'center'},
                {field: 'material', title: '料号', align: 'center'},
                {field: 'materialName', title: '物料名', align: 'center'},
                {field: 'demandQty', title: '需求量', align: 'center'},
                {field: 'lossQty', title: '损耗量', align: 'center'}
            ]],
            size: 'sm',
            page: true,
            limit: 100,
            limits: [20, 50, 70, 100, 200, 300],
            even: true
        });

        table.render({
            elem: '#tableDemandTemp',
            url: '/mrp/getDemandTemp',
            where: {
                mrpVer: '',
                material: ''
            },
            cols: [[
                {type: 'numbers', align: 'center', width: 60},
                {field: 'fabDate', title: '日期', align: 'center'},
                {field: 'material', title: '料号', align: 'center'},
                {field: 'materialName', title: '物料名', align: 'center'},
                {field: 'product', title: 'Product', align: 'center'},
                {field: 'fab', title: 'FAB', align: 'center'},
                {field: 'demandQty', title: '需求量', align: 'center'}
            ]],
            size: 'sm',
            page: true,
            limit: 100,
            limits: [20, 50, 70, 100, 200, 300],
            even: true
        });

        table.render({
            elem: '#tableArrivalPlan',
            data: [],
            cols: [[
                {type: 'numbers', align: 'center', width: 60},
                {field: 'date', title: '日期', align: 'center'},
                {field: 'material', title: '料号', align: 'center'},
                {field: 'supplierCode', title: '供应商编号', align: 'center'},
                {field: 'supplier', title: '供应商名称', align: 'center'},
                {field: 'planQty', title: '计划到货量', align: 'center'}
            ]],
            size: 'sm',
            page: true,
            limit: 100,
            limits: [20, 50, 70, 100, 200, 300],
            even: true
        });

        table.render({
            elem: '#tableBalance',
            data: [],
            cols: [[
                {type: 'numbers', align: 'center', width: 60},
                {field: 'fabDate', title: '日期', align: 'center'},
                {field: 'material', title: '料号', align: 'center'},
                {field: 'materialName', title: '物料名', align: 'center'},
                {field: 'balanceQty', title: '结余量', align: 'center'}
            ]],
            size: 'sm',
            page: true,
            limit: 100,
            limits: [20, 50, 70, 100, 200, 300],
            even: true
        });

        // 表格搜索
        form.on('submit(search)', function (data) {
            if(!data.field.mrpVer) {
                notice.msg('请选择MRP版本', {icon: 5});
                return false;
            }
            var option = {
                calendar: getMrpCalendar(data.field.mrpVer),
                balanceData: getBalanceData(data.field.mrpVer, data.field.material),
                arrivalPlanData: getArrivalPlanData(data.field.mrpVer, data.field.material),
                demandAndLossData: getDemandAndLossData(data.field.mrpVer, data.field.material)
            };
            table.reload('tableDemandTemp', {
                where: {
                    mrpVer: data.field.mrpVer,
                    material: data.field.material
                },
                page: { curr: 1 }
            });
            reloadTables(option);
            return false;
        });

        /**
         * 重新加载表格
         */
        var reloadTables = function(option) {
            table.reload('tableDemandAndLoss', {data: option.demandAndLossData});
            table.reload('tableArrivalPlan', {data: option.arrivalPlanData});
            table.reload('tableBalance', {data: option.balanceData});

            var data = buildTableData(option.demandAndLossData, option.arrivalPlanData, option.balanceData);
            var cols = buildTableCols(option.calendar.days, option.calendar.weeks);
            table.reload('tableMrp', {data: data, cols: cols});
        };

        /**
         * 获取MRP的日期区间日历
         * @param mrpVer mrp版本
         */
        var getMrpCalendar = function(mrpVer) {
            var URL_getCalendar = "/mrp/getDpsCalendar?mrpVer=" + mrpVer;
            var calendar = {};
            $.ajax({
                type : "get",
                url: URL_getCalendar,
                async : false,
                success : function(data){
                    if(data.code === 200) {
                        calendar =  data.data;
                    } else {
                        notice.msg(data.msg, {icon: 2});
                    }
                },
                error: function(res) {
                    notice.msg("获取MRP日历请求失败，" + res.status, {icon: 2});
                }
            });
            return calendar;
        };

        /**
         * 获取材料结余
         * @param mrpVer mrp版本
         * @param material 料号
         */
        var getBalanceData = function(mrpVer, material) {
            var URL_getBalance = "/mrp/getBalance";
            var balanceData = [];
            $.ajax({
                url: URL_getBalance,
                type : "post",
                data: {
                    mrpVer: mrpVer,
                    material: material
                },
                async : false,
                success : function(data){
                    if(data.code === 200) {
                        balanceData =  data.data;
                    } else {
                        notice.msg(data.msg, {icon: 2});
                    }
                },
                error: function(res) {
                    notice.msg("获取材料结余请求失败，" + res.status, {icon: 2});
                }
            });
            return balanceData;
        };

        /**
         * 获取到货计划
         * @param mrpVer mrp版本
         * @param material 料号
         */
        var getArrivalPlanData = function(mrpVer, material) {
            var URL_getArrivalPlan = "/mrp/getArrivalPlan";
            var arrivalPlanData = [];
            $.ajax({
                url: URL_getArrivalPlan,
                type : "post",
                data: {
                    mrpVer: mrpVer,
                    material: material
                },
                async : false,
                success : function(data){
                    if(data.code === 200) {
                        arrivalPlanData =  data.data;
                    } else {
                        notice.msg(data.msg, {icon: 2});
                    }
                },
                error: function(res) {
                    notice.msg("获取到货计划请求失败，" + res.status, {icon: 2});
                }
            });
            return arrivalPlanData;
        };

        /**
         * 获取材料的需求量和损耗量
         * @param mrpVer mrp版本
         * @param material 料号
         */
        var getDemandAndLossData = function(mrpVer, material) {
            var URL_getDemandAndLoss = "/mrp/getDemandAndLoss";
            var demandAndLossData = [];
            $.ajax({
                url: URL_getDemandAndLoss,
                type : "post",
                data: {
                    mrpVer: mrpVer,
                    material: material
                },
                async : false,
                success : function(data){
                    if(data.code === 200) {
                        demandAndLossData =  data.data;
                    } else {
                        notice.msg(data.msg, {icon: 2});
                    }
                },
                error: function(res) {
                    notice.msg("获取材料的需求量和损耗量请求失败，" + res.status, {icon: 2});
                }
            });
            return demandAndLossData;
        };

        /**
         * 构造表格的表头
         * @param days[] 日期数组
         * @param weeks[]  星期数组
         */
        var buildTableCols = function(days, weeks) {
            // 第一行表头
            var col1 = [
                {type: 'numbers', align: 'center', rowspan: 2, fixed: 'left'},
                {field: 'material', title: '料号', align: 'center', rowspan: 2, fixed: 'left', width: 80, sort: true},
                {title: '期初库存', align: 'center', rowspan: 2, fixed: 'left', width: 80},
                {title: '', toolbar: '#DemoPlan',  align: 'center', width: 100, fixed: 'left', rowspan: 2}
            ];
            for(var i=0; i<days.length; i++) {
                col1.push({title: days[i], align: 'center', colspan: 1.1, width: 120});
            }
            // 第二行表头
            var col2 = [];
            for(var j=0; j<weeks.length; j++) {
                var day = days[j];
                col2.push({field: days[j], title: weeks[j],  align: 'center', width: 120,
                    templet: function(data) {
                        var d = {
                            "demandQty": data[day]['demandQty'],
                            "lossQty": data[day]['lossQty'],
                            "balanceQty": data[day]['balanceQty'],
                            "planQty": data[day]['planQty']
                        };

                        return "<div class=\"plan\">\n" +
                            "        <div class=\"plan_child div_border\">"+d.demandQty+"</div>\n" +
                            "        <div class=\"plan_child div_border\">"+d.lossQty+"</div>\n" +
                            "        <div class=\"plan_child div_border\">"+d.planQty+"</div>\n" +
                            "        <div class=\"plan_child div_border\">"+d.balanceQty+"</div>\n" +
                            "    </div>";
                    }
                });
            }
            return [col1, col2];
        };

        /**
         * 构造DPS数据
         * @param demandAndLossData 材料需求和损耗数量
         * @param arrivalPlanData 计划到货数量
         * @param balanceData 材料结余数量
         */
        var buildTableData = function(demandAndLossData, arrivalPlanData, balanceData) {
            var data = [];
            var cursor = {};  // 记录material在数组中的游标，例 { M133 : 1}
            for(var i=0; i<demandAndLossData.length; i++) {
                var demandAndLoss = demandAndLossData[i];
                if(cursor[demandAndLoss.material] || cursor[demandAndLoss.material] === 0) {
                    if(data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]) {
                        data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]['demandQty'] = demandAndLoss.demandQty;
                        data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]['lossQty'] = demandAndLoss.lossQty;
                    } else {
                        data[cursor[demandAndLoss.material]][demandAndLoss.fabDate] = {};
                        data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]['demandQty'] = demandAndLoss.demandQty;
                        data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]['lossQty'] = demandAndLoss.lossQty;
                    }
                } else {
                    data.push({
                        material: demandAndLoss.material,
                        materialName: demandAndLoss.materialName
                    });
                    cursor[demandAndLoss.material] = data.length-1;
                    data[cursor[demandAndLoss.material]][demandAndLoss.fabDate] = {};
                    data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]['demandQty'] = demandAndLoss.demandQty;
                    data[cursor[demandAndLoss.material]][demandAndLoss.fabDate]['lossQty'] = demandAndLoss.lossQty;
                }
            }
            for(var i=0; i<arrivalPlanData.length; i++) {
                var arrivalPlan = arrivalPlanData[i];
                if(cursor[arrivalPlan.material] || cursor[arrivalPlan.material] === 0) {
                    if(data[cursor[arrivalPlan.material]][arrivalPlan.fabDate]) {
                        data[cursor[arrivalPlan.material]][arrivalPlan.fabDate]['planQty'] = arrivalPlan.planQty;
                    } else {
                        data[cursor[arrivalPlan.material]][arrivalPlan.fabDate] = {};
                        data[cursor[arrivalPlan.material]][arrivalPlan.fabDate]['planQty'] = arrivalPlan.planQty;
                    }
                } else {
                    data.push({
                        material: arrivalPlan.material,
                        materialName: arrivalPlan.materialName
                    });
                    cursor[arrivalPlan.material] = data.length-1;
                    data[cursor[arrivalPlan.material]][arrivalPlan.fabDate] = {};
                    data[cursor[arrivalPlan.material]][arrivalPlan.fabDate]['planQty'] = arrivalPlan.planQty;
                }
            }
            for(var i=0; i<balanceData.length; i++) {
                var balance = balanceData[i];
                if(cursor[balance.material] || cursor[balance.material] === 0) {
                    if(data[cursor[balance.material]][balance.fabDate]) {
                        data[cursor[balance.material]][balance.fabDate]['balanceQty'] = balance.balanceQty;
                    } else {
                        data[cursor[balance.material]][balance.fabDate] = {};
                        data[cursor[balance.material]][balance.fabDate]['balanceQty'] = balance.balanceQty;
                    }
                } else {
                    data.push({
                        material: balance.material,
                        materialName: balance.materialName
                    });
                    cursor[balance.material] = data.length-1;
                    data[cursor[balance.material]][balance.fabDate] = {};
                    data[cursor[balance.material]][balance.fabDate]['balanceQty'] = balance.balanceQty;
                }
            }
            return data;
        };

    });
</script>
</body>
</html>